name: KivyMD CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ────────────────────────────────
  # 1. Headless test – nikdy viac "Unable to find Window provider"
  # ────────────────────────────────
  test_headless:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Fix repos + install all system dependencies
        run: |
          sudo rm -f /etc/apt/sources.list.d/*.list
          echo "deb http://archive.ubuntu.com/ubuntu noble main restricted universe multiverse"         | sudo tee /etc/apt/sources.list
          echo "deb http://archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb http://security.ubuntu.com/ubuntu noble-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential git zip unzip python3-dev python3-pip \
            libffi-dev libssl-dev \
            libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
            libmtdev-dev libgl1-mesa-dev libgles2-mesa-dev \
            xclip xsel libcairo2-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            autoconf automake libtool pkg-config

      - name: Install Kivy master + KivyMD
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir https://github.com/kivy/kivy/archive/master.zip
          pip install --no-cache-dir kivymd==2.0.1.dev0
          # ak chceš úplne najnovšie KivyMD, odkomentuj radšej tento riadok:
          # pip install --no-cache-dir git+https://github.com/kivymd/KivyMD.git@master

      - name: Ultra-fast headless test (3–8 sekúnd)
        run: |
          python - <<'PYTHON'
          import os
          os.environ["KIVY_NO_WINDOW"]   = "1"
          os.environ["KIVY_WINDOW"]      = "offscreen"
          os.environ["KIVY_CLIPBOARD"]   = "dummy"
          os.environ["SDL_VIDEODRIVER"]  = "dummy"
          os.environ["SDL_AUDIODRIVER"]  = "dummy"

          # Načíta celú appku a všetky .kv súbory (ak niečo chýba, zlyhá hneď)
          from main import NavigationDrawerApp   # ← ak sa tvoja trieda volá inak, oprav názov
          app = NavigationDrawerApp()
          app.load_all_kv_files()
          app.build()                           # overí, že sa dá vytvoriť root widget
          print("Headless test PASSED – všetko sa naimportovalo a KV súbory sú OK")
          PYTHON

  # ────────────────────────────────
  # 2. Android build (20–30 min, len arm64-v8a)
  # ────────────────────────────────
  build_android:
    needs: test_headless
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build APK
        uses: ArtemSBulgakov/buildozer-action@v1
        with:
          command: buildozer android debug
          buildozer_version: master
          workdir: .

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: KivyMD-Example-APK
          path: bin/*.apk
          retention-days: 14
