# Názov workflow, ktorý sa zobrazí v GitHub Actions
name: KivyMD CI/CD

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Umožňuje manuálne spustenie

jobs:
  # ----------------------------------------------------
  # ÚLOHA 1: Test závislostí a KivyMD inštalácie (v Pythone)
  # ----------------------------------------------------
  test_dependencies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ZMENA: Pridaná knižnica libcairo2-dev pre vyriešenie chyby pycairo
      - name: Install System Dependencies (for Kivy and Cairo)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-mixer-dev \
            libsdl2-ttf-dev \
            pkg-config \
            libcairo2-dev # Zabezpečí, že knižnica Cairo je dostupná pre Meson build pycairo

      - name: Install Kivy and KivyMD (using master branch for dev version)
        run: |
          pip install kivy
          # Inštalácia KivyMD dev verzie priamo z master vetvy
          pip install git+https://github.com/kivymd/KivyMD.git@master

      - name: Test Application Loading (KIVY_NO_WINDOW=1)
        run: |
          # Spustí kód bez grafického okna, len pre overenie, že sa správne načíta a spracuje KV
          python main.py
        env:
          KIVY_NO_WINDOW: 1

  # ----------------------------------------------------
  # ÚLOHA 2: Buildozer Android Build (Vyžaduje buildozer.spec)
  # ----------------------------------------------------
  build_android_apk:
    # Táto úloha sa spustí len ak predchádzajúci test prebehol úspešne
    needs: test_dependencies
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # Používame špecializovanú akciu, ktorá spúšťa Buildozer v Docker kontajneri s celým Android SDK
      - name: Run Buildozer Android Debug Build
        uses: clyang/buildozer-action@v1
        with:
          # Spustenie balenia pre Android (debug verzia)
          command: buildozer android debug

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          # Buildozer ukladá výsledné súbory do adresára bin/
          path: bin/*.apk
          # Uloží artefakt len na 7 dní
          retention-days: 7
